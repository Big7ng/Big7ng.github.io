<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Nginx安装nginx-http-flv-module模块开启HTTP-FLV直播 · Big7ng's Blog</title><meta name="description" content="Nginx安装nginx-http-flv-module模块开启HTTP-FLV直播 - Big7ng"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://big7ng.github.io/atom.xml" title="Big7ng's Blog"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Big7ng's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Big7ng" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Nginx安装nginx-http-flv-module模块开启HTTP-FLV直播</h1><div class="post-info">Mar 30, 2024</div><div class="post-content"><p>使用ffmpeg推流的rtmp协议视频无法在浏览器中播放，因此本文使用Nginx作为一个服务器，将rtmp协议的媒体流转换为http+flv格式</p>
<h1 id="安装Nginx与nginx-http-flv-module"><a href="#安装Nginx与nginx-http-flv-module" class="headerlink" title="安装Nginx与nginx-http-flv-module"></a>安装Nginx与nginx-http-flv-module</h1><p>下载nginx-http-flv-module源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/winshining/nginx-http-flv-module.git</span><br></pre></td></tr></table></figure>

<p>下载nginx源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://nginx.org/download/nginx-1.24.0.tar.gz</span><br><span class="line">tar xzf nginx-1.24.0.tar.gz</span><br></pre></td></tr></table></figure>

<p>也可以在<a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">Nginx官网</a>查看需要的版本。</p>
<p>安装pcre、zlib、openssl</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install libpcre3 libpcre3-dev zlib1g-dev openssl libssl-dev</span><br></pre></td></tr></table></figure>

<p>开始编译，需要把<code>/path/to/nginx-http-flv-module</code>替换为nginx-http-flv-module源码的下载目录，我这里是&#x2F;home&#x2F;sun&#x2F;nginx-http-flv-module</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> nginx-1.24.0/</span><br><span class="line">./configure --add-module=/path/to/nginx-http-flv-module</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h1 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h1><p>打开<code>/usr/local/nginx/conf</code>目录，修改<code>nginx.conf</code>配置文件。</p>
<p>我这里把http服务器设置为8080，rtmp服务器设为1935，这里需要注意的是，如果要访问<code>http://localhost:8080/stat</code>来查看Nginx服务器运行情况，需要把nginx-http-flv-module源码目录下的<code>stat.xsl</code>文件拷贝至<code>/var/www/rtmp/</code>文件夹。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;	#worker进程的数量</span><br><span class="line">error_log  logs/error.log  error;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;	#每个worker进程可以接收多少个网络连接</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       8080;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   docs/html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">       location /live &#123;</span><br><span class="line">            flv_live on; #open flv live streaming (subscribe)</span><br><span class="line">            chunked_transfer_encoding on; #open &#x27;Transfer-Encoding: chunked&#x27; response</span><br><span class="line">        	#不增加以下这两行配置的话，无法使用浏览器获取视频流</span><br><span class="line">        	add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;; #add additional HTTP header</span><br><span class="line">            add_header &#x27;Access-Control-Allow-Credentials&#x27; &#x27;true&#x27;; #add additional HTTP header</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location /stat &#123;</span><br><span class="line">            #configuration of streaming &amp; recording statistics</span><br><span class="line"></span><br><span class="line">            rtmp_stat all;</span><br><span class="line">            rtmp_stat_stylesheet stat.xsl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /stat.xsl &#123;</span><br><span class="line">            root /var/www/rtmp; #specify in where stat.xsl located</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location /control &#123;</span><br><span class="line">            rtmp_control all; #configuration of control module of rtmp</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rtmp_auto_push on;</span><br><span class="line">rtmp_auto_push_reconnect 1s;</span><br><span class="line">rtmp_socket_dir /tmp;</span><br><span class="line"></span><br><span class="line">rtmp &#123;</span><br><span class="line">    out_queue   4096;</span><br><span class="line">    out_cork    16;</span><br><span class="line">    max_streams 128;</span><br><span class="line">    timeout             15s;</span><br><span class="line">    drop_idle_publisher 15s;</span><br><span class="line"> </span><br><span class="line"> 	log_interval 5s; #log 模块在 access.log 中记录日志的间隔时间，对调试非常有用</span><br><span class="line">    log_size     1m; #log 模块用来记录日志的缓冲区大小</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">        listen 1935;</span><br><span class="line">        server_name localhost;</span><br><span class="line"></span><br><span class="line">        application myapp &#123;</span><br><span class="line">            live on;</span><br><span class="line">            gop_cache off; #open GOP cache for low latency</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>推流地址为<code>rtmp://example.com[:port]/appname/streamname</code>，根据以上配置，本机的地址为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rtmp://127.0.0.1:1935/myapp/mystream</span><br></pre></td></tr></table></figure>

<p>拉流地址为<code>http://example.com[:port]/dir?[port=xxx&amp;]app=appname&amp;stream=streamname</code>，根据以上配置，本机的地址为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/live?port=1935&amp;app=myapp&amp;stream=mystream</span><br></pre></td></tr></table></figure>



<h1 id="推流至Nginx服务器"><a href="#推流至Nginx服务器" class="headerlink" title="推流至Nginx服务器"></a>推流至Nginx服务器</h1><p>nginx的使用命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/local/nginx/sbin/nginx -t <span class="comment">#检查配置文件是否正确</span></span><br><span class="line">sudo /usr/local/nginx/sbin/nginx	<span class="comment">#启动nginx服务器</span></span><br><span class="line">sudo /usr/local/nginx/sbin/nginx -s stop	<span class="comment">#关闭nginx服务器</span></span><br><span class="line">sudo /usr/local/nginx/sbin/nginx -s reload	<span class="comment">#重启nginx服务器</span></span><br></pre></td></tr></table></figure>

<p>使用ffmpeg读取摄像头的内容并编码成h264格式并使用rtmp协议推流至nginx服务器中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/bin/ffmpeg -input_format mjpeg  -video_size 640x480 -f v4l2  -i /dev/video0 -c:v libx264 -tune zerolatency -preset ultrafast -g 1 -f flv rtmp://127.0.0.1:1935/myapp/mystream</span><br></pre></td></tr></table></figure>

<p><code>-g 1</code>表示关键帧间隔为1, <code>-tune zerolatency</code>表示编码器的参数配置为低延迟做优化，<code>-preset ultrafast</code>表示降低输出画质以降低cpu利用率、提高编码速度。</p>
<p>这里也可以使用OBS来进行推流，需要注意，此时推流地址为<code>rtmp://127.0.0.1:1935/myapp</code>，推流码为<code>mystream</code>。</p>
<p>使用ffplay查看http+flv格式的直播</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/bin/ffplay <span class="string">&quot;http://127.0.0.1:8080/live?port=1935&amp;app=myapp&amp;stream=mystream&quot;</span></span><br><span class="line">~/bin/ffplay <span class="string">&quot;http://192.168.164.33:8080/live?port=1935&amp;app=myapp&amp;stream=mystream&quot;</span></span><br></pre></td></tr></table></figure>

<p>经过测试，这样会有2~3秒的延迟，在ffplay命令中添加<code>-fflags nobuffer</code>选项可以实现1秒左右的延迟</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/bin/ffplay <span class="string">&quot;http://127.0.0.1:8080/live?port=1935&amp;app=myapp&amp;stream=mystream&quot;</span> -fflags nobuffer</span><br><span class="line">~/bin/ffplay <span class="string">&quot;http://192.168.164.33:8080/live?port=1935&amp;app=myapp&amp;stream=mystream&quot;</span> -fflags nobuffer</span><br></pre></td></tr></table></figure>





</div></article></div></main><footer><div class="paginator"><a href="/2024/04/07/virtualenv/" class="prev">PREV</a><a href="/2024/03/24/fastdeploy/" class="next">NEXT</a></div><div class="copyright"><p>© 2022 - 2024 <a href="https://big7ng.github.io">Big7ng</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>